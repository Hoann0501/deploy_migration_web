<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>D·ª± b√°o Di c∆∞</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
</head>
<body>
  <div class="main-container">
    <h1>üìà D·ª± b√°o T·ª∑ l·ªá Di c∆∞ (2025‚Äì2030)</h1>
    
    <div class="toggle-container">
      <button id="single-mode-btn" class="toggle-btn active">üîç D·ª± ƒëo√°n ƒë∆°n l·∫ª</button>
      <button id="map-mode-btn" class="toggle-btn">üó∫Ô∏è B·∫£n ƒë·ªì t·ªïng quan</button>
    </div>

    <div id="single-mode" class="content-wrapper">
      <div class="left-panel">
        <div class="form-container">
          <form id="predict-form">
            <label>T·ªânh/Th√†nh ph·ªë:</label>
            <select id="province">
              {% for p in provinces %}
                <option>{{ p }}</option>
              {% endfor %}
            </select>

            <label>NƒÉm d·ª± ƒëo√°n:</label>
            <input type="number" id="year" min="2025" max="2030" value="2025">

            <button type="submit">üîç D·ª± ƒëo√°n</button>
          </form>

          <div id="result" style="display:none;">
            <h2>D·ª± b√°o üìä</h2>
            <p id="prediction"></p>
            <div id="trend-text"></div>
            <h3>üìö D·ªØ li·ªáu li√™n quan:</h3>
            <div id="explanation"></div>
          </div>
        </div>
      </div>

      <div class="right-panel">
        <div class="map-container">
          <h3>üó∫Ô∏è B·∫£n ƒë·ªì Vi·ªát Nam</h3>
          <div id="map"></div>
          <p class="map-info">Ch·ªçn t·ªânh/th√†nh ph·ªë ƒë·ªÉ xem v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì</p>
        </div>
      </div>
    </div>

    <div id="map-mode" class="content-wrapper" style="display:none;">
      <div class="map-controls">
        <div class="controls-container">
          <label>NƒÉm d·ª± ƒëo√°n:</label>
          <input type="number" id="map-year" min="2025" max="2030" value="2025">
          <button id="update-map-btn">üîÑ C·∫≠p nh·∫≠t b·∫£n ƒë·ªì</button>
        </div>
        <div class="legend">
          <h3>üìä Ch√∫ th√≠ch t·ª∑ l·ªá di c∆∞ (‚Ä∞):</h3>
          <div class="legend-item">
            <div class="legend-color" style="background: #800026;"></div>
            <span>Di c∆∞ ra r·∫•t m·∫°nh (&lt; -15‚Ä∞)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #BD0026;"></div>
            <span>Di c∆∞ ra m·∫°nh (-15‚Ä∞ ƒë·∫øn -10‚Ä∞)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #E31A1C;"></div>
            <span>Di c∆∞ ra v·ª´a (-10‚Ä∞ ƒë·∫øn -5‚Ä∞)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #FC4E2A;"></div>
            <span>Di c∆∞ ra nh·∫π (-5‚Ä∞ ƒë·∫øn 0‚Ä∞)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #FD8D3C;"></div>
            <span>C√¢n b·∫±ng (0‚Ä∞ ƒë·∫øn 2‚Ä∞)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #FEB24C;"></div>
            <span>Di c∆∞ v√†o nh·∫π (2‚Ä∞ ƒë·∫øn 5‚Ä∞)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #FED976;"></div>
            <span>Di c∆∞ v√†o v·ª´a (5‚Ä∞ ƒë·∫øn 10‚Ä∞)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #FFEDA0;"></div>
            <span>Di c∆∞ v√†o m·∫°nh (&gt; 10‚Ä∞)</span>
          </div>
        </div>
      </div>
      
      <div class="full-map-container">
        <h3>üó∫Ô∏è B·∫£n ƒë·ªì T·ª∑ l·ªá Di c∆∞ Vi·ªát Nam</h3>
        <div id="full-map"></div>
        <p class="map-info">Nh·∫•p v√†o t·ªânh/th√†nh ph·ªë ƒë·ªÉ xem th√¥ng tin chi ti·∫øt</p>
      </div>
    </div>
  </div>

  <script>
    const map = L.map('map').setView([16.0, 106.0], 6);
    let fullMap = null;
    let currentPredictions = {};
    let geojsonLayer = null;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    const provinceCoords = {
      'An Giang': [10.5216, 105.1258],
      'B√† R·ªãa - V≈©ng T√†u': [10.5417, 107.2431],
      'B·∫Øc Giang': [21.2731, 106.1946],
      'B·∫Øc K·∫°n': [22.1474, 105.8348],
      'B·∫°c Li√™u': [9.2945, 105.7244],
      'B·∫Øc Ninh': [21.1864, 106.0752],
      'B·∫øn Tre': [10.2433, 106.3756],
      'B√¨nh ƒê·ªãnh': [13.7765, 109.2216],
      'B√¨nh D∆∞∆°ng': [11.3254, 106.4775],
      'B√¨nh Ph∆∞·ªõc': [11.7511, 106.7234],
      'B√¨nh Thu·∫≠n': [11.0904, 108.0721],
      'C√† Mau': [9.1769, 105.1524],
      'C·∫ßn Th∆°': [10.0452, 105.7469],
      'Cao B·∫±ng': [22.6356, 106.2550],
      'ƒê√† N·∫µng': [16.0544, 108.2022],
      'ƒê·∫Øk L·∫Øk': [12.7100, 108.2378],
      'ƒê·∫Øk N√¥ng': [12.2646, 107.6098],
      'ƒêi·ªán Bi√™n': [21.8042, 103.2287],
      'ƒê·ªìng Nai': [11.0686, 107.1676],
      'ƒê·ªìng Th√°p': [10.4938, 105.6881],
      'Gia Lai': [13.8078, 108.1099],
      'H√† Giang': [22.8025, 104.9784],
      'H√† Nam': [20.5835, 105.9230],
      'H√† N·ªôi': [21.0285, 105.8542],
      'H√† Tƒ©nh': [18.2943, 105.8906],
      'H·∫£i D∆∞∆°ng': [20.9373, 106.3148],
      'H·∫£i Ph√≤ng': [20.8449, 106.6881],
      'H·∫≠u Giang': [9.7571, 105.6412],
      'H√≤a B√¨nh': [20.6861, 105.3131],
      'H∆∞ng Y√™n': [20.6464, 106.0512],
      'Kh√°nh H√≤a': [12.2585, 109.0526],
      'Ki√™n Giang': [10.0125, 105.0811],
      'Kon Tum': [14.3497, 108.0005],
      'Lai Ch√¢u': [22.3686, 103.4574],
      'L√¢m ƒê·ªìng': [11.5753, 108.1429],
      'L·∫°ng S∆°n': [21.8564, 106.7610],
      'L√†o Cai': [22.4856, 103.9707],
      'Long An': [10.6958, 106.2431],
      'Nam ƒê·ªãnh': [20.4388, 106.1621],
      'Ngh·ªá An': [19.2342, 104.9200],
      'Ninh B√¨nh': [20.2506, 105.9744],
      'Ninh Thu·∫≠n': [11.6739, 108.8629],
      'Ph√∫ Th·ªç': [21.2685, 105.2045],
      'Ph√∫ Y√™n': [13.1611, 109.0899],
      'Qu·∫£ng B√¨nh': [17.6102, 106.3487],
      'Qu·∫£ng Nam': [15.5394, 108.0191],
      'Qu·∫£ng Ng√£i': [15.1214, 108.8044],
      'Qu·∫£ng Ninh': [21.0064, 107.2925],
      'Qu·∫£ng Tr·ªã': [16.7943, 106.9629],
      'S√≥c TrƒÉng': [9.6036, 105.9802],
      'S∆°n La': [21.3256, 103.9188],
      'T√¢y Ninh': [11.3350, 106.1017],
      'Th√°i B√¨nh': [20.4463, 106.3365],
      'Th√°i Nguy√™n': [21.5613, 105.8242],
      'Thanh H√≥a': [19.8067, 105.7851],
      'Th·ª´a Thi√™n Hu·∫ø': [16.4637, 107.5909],
      'Ti·ªÅn Giang': [10.4493, 106.3420],
      'TP. H·ªì Ch√≠ Minh': [10.8231, 106.6297],
      'Tr√† Vinh': [9.9477, 106.3256],
      'Tuy√™n Quang': [21.7767, 105.2281],
      'Vƒ©nh Long': [10.2397, 105.9570],
      'Vƒ©nh Ph√∫c': [21.3608, 105.5474],
      'Y√™n B√°i': [21.7229, 104.8986]
    };

    let currentMarker = null;
    let currentCircle = null;

    function getColor(value) {
      if (value < -15) return '#800026';
      if (value < -10) return '#BD0026';
      if (value < -5) return '#E31A1C';
      if (value < 0) return '#FC4E2A';
      if (value < 2) return '#FD8D3C';
      if (value < 5) return '#FEB24C';
      if (value < 10) return '#FED976';
      return '#FFEDA0';
    }

    function style(feature) {
      const provinceName = feature.properties.NAME_1;
      const prediction = currentPredictions[provinceName] || 0;
      return {
        fillColor: getColor(prediction),
        weight: 2,
        opacity: 1,
        color: 'white',
        dashArray: '3',
        fillOpacity: 0.7
      };
    }

    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({
        weight: 5,
        color: '#666',
        dashArray: '',
        fillOpacity: 0.7
      });
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
      }
    }

    function resetHighlight(e) {
      geojsonLayer.resetStyle(e.target);
    }

    function zoomToFeature(e) {
      fullMap.fitBounds(e.target.getBounds());
    }

    function onEachFeature(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: function(e) {
          const provinceName = feature.properties.NAME_1;
          const prediction = currentPredictions[provinceName] || 0;
          const popupContent = `
            <div style="text-align: center; font-weight: bold; min-width: 200px;">
              <h3 style="margin: 0 0 10px 0; color: #007acc;">${provinceName}</h3>
              <p style="margin: 5px 0; font-size: 16px;">T·ª∑ l·ªá di c∆∞: <span style="color: ${getColor(prediction)};">${prediction.toFixed(2)}‚Ä∞</span></p>
              <p style="margin: 5px 0; color: ${getColor(prediction)}; font-weight: bold;">
                ${prediction > 0 ? 'üìà Xu h∆∞·ªõng di c∆∞ v√†o' : 'üìâ Xu h∆∞·ªõng di c∆∞ ra'}
              </p>
            </div>
          `;
          layer.bindPopup(popupContent).openPopup();
        }
      });
    }

    function initializeFullMap() {
      if (fullMap) return;
      
      fullMap = L.map('full-map').setView([16.0, 106.0], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(fullMap);
      
      loadGeoJSONData();
    }

    async function loadGeoJSONData() {
      try {
        const response = await fetch('/static/vietnam-provinces.geojson');
        const geojsonData = await response.json();
        
        if (geojsonLayer) {
          fullMap.removeLayer(geojsonLayer);
        }
        
        geojsonLayer = L.geoJSON(geojsonData, {
          style: style,
          onEachFeature: onEachFeature
        }).addTo(fullMap);
        
        fullMap.fitBounds(geojsonLayer.getBounds());
        
      } catch (error) {
        console.error('Error loading GeoJSON data:', error);
      }
    }

    async function updateMapPredictions() {
      const year = document.getElementById('map-year').value;
      
      try {
        const response = await fetch('/predict_all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ year: year })
        });
        
        currentPredictions = await response.json();
        
        if (geojsonLayer) {
          geojsonLayer.setStyle(style);
        }
        
      } catch (error) {
        console.error('Error updating predictions:', error);
      }
    }

    document.getElementById('single-mode-btn').addEventListener('click', function() {
      document.getElementById('single-mode').style.display = 'flex';
      document.getElementById('map-mode').style.display = 'none';
      this.classList.add('active');
      document.getElementById('map-mode-btn').classList.remove('active');
    });

    document.getElementById('map-mode-btn').addEventListener('click', function() {
      document.getElementById('single-mode').style.display = 'none';
      document.getElementById('map-mode').style.display = 'block';
      this.classList.add('active');
      document.getElementById('single-mode-btn').classList.remove('active');
      
      setTimeout(() => {
        initializeFullMap();
        updateMapPredictions();
      }, 100);
    });

    document.getElementById('update-map-btn').addEventListener('click', updateMapPredictions);

    function highlightProvince(provinceName) {
      if (currentMarker) {
        map.removeLayer(currentMarker);
      }
      if (currentCircle) {
        map.removeLayer(currentCircle);
      }

      const coords = provinceCoords[provinceName];
      if (coords) {
        currentMarker = L.marker(coords)
          .addTo(map)
          .bindPopup(`<b>${provinceName}</b><br>T·ªânh/Th√†nh ph·ªë ƒë∆∞·ª£c ch·ªçn`)
          .openPopup();

        currentCircle = L.circle(coords, {
          color: '#007acc',
          fillColor: '#007acc',
          fillOpacity: 0.3,
          radius: 50000
        }).addTo(map);

        map.setView(coords, 8);
      }
    }

    document.getElementById('province').addEventListener('change', function() {
      const selectedProvince = this.value;
      highlightProvince(selectedProvince);
    });

    document.addEventListener('DOMContentLoaded', function() {
      const firstProvince = document.getElementById('province').value;
      if (firstProvince) {
        highlightProvince(firstProvince);
      }
    });

    document.getElementById("predict-form").addEventListener("submit", async function(e) {
      e.preventDefault();
      const province = document.getElementById("province").value;
      const year = document.getElementById("year").value;

      highlightProvince(province);

      const response = await fetch("/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ province, year })
      });
      const data = await response.json();
      document.getElementById("prediction").innerText = `T·ªâ su·∫•t di c∆∞ thu·∫ßn: ${data.prediction.toFixed(2)} ‚Ä∞`;
      document.getElementById("trend-text").innerHTML = data.trend_text;
      document.getElementById("explanation").innerHTML = data.explanation;
      document.getElementById("result").style.display = "block";
    });
  </script>
</body>
</html>
